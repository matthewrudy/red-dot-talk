<!DOCTYPE html>
<html>
<head>
	<meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
	<title>Build a Financial App in Ruby</title>
	<meta name="author" content="Matthew Rudy Jacobs" />
	<meta name="email" content="MatthewRudyJacobs@gmail.com" />
	<meta name="venue" content="RedDotRubyConf 2011" />
	<meta name="date" content="Saturday 23rd April 2011" />

	<link type="text/css" rel="stylesheet" href="stylesheets/slippy.css"/>
	<link type="text/css" rel="stylesheet" href="stylesheets/slippy-dark.css"/>
	
	<link type="text/css" rel="stylesheet" href="stylesheets/shCore.css"/>
	<link type="text/css" rel="stylesheet" href="stylesheets/shThemeMidnight.css"/>

	<!-- Slippy core file and dependencies -->
	<script type="text/javascript" src="javascripts/jquery.min.js"></script>
	<script type="text/javascript" src="javascripts/jquery.history.js"></script>
	<script type="text/javascript" src="javascripts/slippy.js"></script>
	
	<script type="text/javascript" src="javascripts/shCore.js"></script>
	<script type="text/javascript" src="javascripts/shBrushRuby.js"></script>
	
	<style type="text/css">
	  .slide pre {
	    font-size : 0.7em;
	  }
	  h1 {
	    font-size : 2.5em;
	  }
	  li {
	    padding : 0.5em 0;
	  }
	</style>

	<!-- Slippy init code -->
	<script type="text/javascript">
	$(function() {
		$(".slide").slippy({widthInCharacters: 20});
	});
	</script>
</head>
<body>
	<div class="slide">
	  <h1>Building a Financial App in Ruby</h1>
	  <p>Red Dot Ruby Conf</p>
	  <p>Saturday 23rd April 2011</p>
	</div>
	
	
	<div class="slide">
	  <h1>Who Am I?</h1>
	  <ul>
	    <li class="incremental">Matthew Rudy Jacobs</li>
	    <li class="incremental">马泰</li>
	    <li class="incremental">@MatthewRudy</li>
	  </ul>
	</div>
	
	<div class="slide">
	  <h1>I have ear hair!</h1>
	  <h2 class="incremental">But I don't have time to talk about it</h2>
	</div>
	
	<div class="slide">
	  <h1>Thought Sauce</h1>
	  <ul>
	    <li class="incremental">Fledgling Consultancy in HK</li>
	    <li class="incremental">We need more people!</li>
	    <li class="incremental">And we need more work!</li>
	  </ul>
	</div>
	
	<div class="slide">
	  <h1>The Talk</h1>
	</div>
	
	<div class="slide">
    <h1>Why is finance different?</h1>
    <ul>
      <li class="incremental">Surely its just building internal apps</li>
      <li class="incremental">Isn't that boring?</li>
    </ul>
  </div>
  
  <div class="slide">
    <h1>Yes</h1>
  </div>
  
  <div class="slide">
    <h1>Our Client</h1>
    <h2>Advanced-Pay.com</h2>
    <p>"Lending against credit card receivables"</p>
  </div>
  
  <div class="slide">
    <h2>Risk Analysis</h2>
    <ul>
      <li class="incremental">6 months credit card statements</li>
      <li class="incremental">We analyse them</li>
      <li class="incremental">Are they going to go bust?</li>
      <li class="incremental">How much can they afford to pay daily?</li>
      <li class="incremental">Derive a credit limit</li>
    </ul>
  </div>
  
  <div class="slide">
    <h2>Loan Management</h2>
    <ul>
      <li class="incremental">Approve and Disburse Loans</li>
      <li class="incremental">Take Daily Repayments</li>
      <li class="incremental">Monthly PDF Statements</li>
      <li class="incremental">Ongoing Risk Analysis</li>
    </ul>
  </div>
  
  <div class="slide">
    <img src="images/model-diagram.png" />
  </div>
  
  <div class="slide">
    <h1>Key features</h1>
    <ul>
      <li class="incremental">Small User Base</li>
      <li class="incremental">Function over Form</li>
      <li class="incremental">Its all about numbers</li>
      <li class="incremental">No f**k ups</li>
    </ul>
  </div>
  
  <div class="slide">
    <h2>10 Key approaches</h2>
    
    <ul>
      <li class="incremental">1. Data Integrity</li>
      <li class="incremental">2. State Machines</li>
      <li class="incremental">3. Pessimistic Locking</li>
      <li class="incremental">4. Audit Everything</li>
      <li class="incremental">5. Currency Handling</li>
    </ul>
  </div>
  
  <div class="slide">
    <h2>10 Key approaches</h2>
    
    <ul>
      <li class="incremental">6. Use a Ledger</li>
      <li class="incremental">7. Round</li>
      <li class="incremental">8. System Security</li>
      <li class="incremental">9. Data Security</li>
      <li class="incremental">10. ?</li>
    </ul>
  </div>
  
  <div class="slide">
    <h1>1. Data Integrity</h1>
    <h2>Its the the Data that Matters</h2>
  </div>
  
  <div class="slide">
    <h1>Foreign Keys</h1>
    
    <p class="incremental">If Direct Debit Request 45623 doesn't exist, something has gone wrong!</p>
  </div>
  
  <div class="slide">
    <h1>Unique Indexes</h1>
    
    <p class="incremental">There can only be one "disbursed" Loan per client</p>
  </div>
  
  <div class="slide">
    <h2>I'd like to say</h2>
    <ul>
      <li class="incremental">CHECK constraints</li>
      <li class="incremental">Partial Indexes</li>
    </ul>
    <p class="incremental">But these get in the way</p>
  </div>
  
  <div class="slide">
    <h1>2. State Machines</h1>
    <h2>Everything is a process</h2>
  </div>
  
  <div class="slide"> 
    <h2>Loan Lifecyle</h2>
    <ul>
      <li class="incremental">Requested</li>
      <li class="incremental">Approved (for an amount)</li>
      <li class="incremental">Disbursed</li>
      <li class="incremental">Paid Off</li>
    </ul>
  </div>
  
  <div class="slide"> 
    <h2>Task Lifecyle</h2>
    <ul>
      <li class="incremental">Created</li>
      <li class="incremental">Started Processing</li>
      <li class="incremental">Finished Processing</li>
    </ul>
  </div>
   
  <div class="slide">
    <h2>Common Approach</h2>
    <pre class="brush: ruby">
class SomeTask < ActiveRecord::Base
  super_state :pending, :initial => true
  super_state :processing
  super_state :completed
  super_state :failed

  super_state_group :outstanding,
    ["pending", "processing"]
end
    </pre>
  </div>
  
  <div class="slide">
    <h1>3. Pessimistic Locking</h1>
    
    <h2>Keep your hands off my task</h2>
  </div>
    
  <div class="slide">
    <pre>
class SomeTask < ActiveRecord::Base
  # kick of the process
  state_transition :start_processing,
    :pending => :processing

  # finish it off
  state_transition :complete_processing,
    :processing => :completed

  def process!
    ensure_super_state!(:pending) do
      self.start_processing!
    end

    # do our stuff

    complete_processing!
  end
end
    </pre>
  </div>
  
  <div class="slide">
    <h1>Workflow</h1>
    <ul>
      <li class="incremental">Lock it!</li>
      <li class="incremental">Change the state!</li>
      <li class="incremental">Do your work!</li>
    </ul>
  </div>
  
  <div class="slide">
    <h1>If it fails?</h1>
    <ul>
      <li class="incremental">Something unexpected has happened</li>
      <li class="incremental">We need to fix it manually</li>
    </ul>
  </div>

  <div class="slide">
    <h1>4. Audit Everything</h1>
    <h2>Who did what, when?</h2>
  </div>
  
  <div class="slide">
    <h2>Just do it</h2>
    <pre class="brush: ruby">
def audit_this!
  ActionAudit.audit!(
    :ip => request.remote_ip,
    :controller => params[:controller],
    :action     => params[:action],
    :params     => request.filtered_parameters,
    :flash      => flash,
    :status     => status,
    :http_verb  => request.request_method,
    :user       => current_user
    )
rescue Exception => e
  logger.error("Auditing is broken: #{e.message}")
end
after_filter :audit_this
    </pre>
  </div>
  
  <div class="slide">
    <h1>5. Currency</h1>
    <h2>Floats, Decimals, or Integers?</h2>
  </div>
  
  <div class="slide">
    <h1>Amounts</h1>
    <ul>
      <li class="incremental">100_000.00 US Dollars</li>
      <li class="incremental">50_000.00 British Pounds</li>
      <li class="incremental">600_000.00 Hong Kong Dollars</li>
      <li class="incremental">1_000_000 Korean Won</li>
    </ul>
  </div>
  
  <div class="slide">
    <h1>Use Integers!</h1>
  </div>
  
  <div class="slide">
    <h1>Cashish</h1>
    <pre class="brush: ruby">
>> Cashish::Amount.new(100_000_00, "USD")
=> 100,000.00 USD

>> Cashish::Amount.new(50_000_00, "GBP")
=> 50,000.00 GBP

>> Cashish::Amount.new(1_000_000, "KRW")
=> 1,000,000 KRW
    </pre>
  </div>
  
  <div class="slide">
    <h1>6. Ledgers</h1>
    <h2>Them things accountants use</h2>
  </div>
  
  <div class="slide">
    <h1>What is a loan?</h1>
    <ul>
      <li class="incremental">A Principal</li>
      <li class="incremental">Some Interest</li>
      <li class="incremental">Daily Amount</li>
    </ul>
  </div>
  
  <div class="slide">
    <h2>Plus a load more s**t</h2>
    <ul>
      <li>Payment Requests</li>
      <li>Payment Failures</li>
      <li>Fees</li>
      <li>Early Payments</li>
      <li>Top Ups</li>
    </ul>
  </div>
  
  <div class="slide">
    <h1>Each of these is a mixture of</h1>
    <ul>
      <li class="incremental">Principal</li>
      <li class="incremental">Interest</li>
      <li class="incremental">Fees</li>
    </ul>
  </div>
  
  <div class="slide">
    <h1>Try it OO</h1>
    <h2>It gets messy very quickly</h2>
  </div>
  
  <div class="slide">
    <h2>Make the loan look like the Statement</h2>
    <pre>
Amount Disbursed: 100,000 HKD
Initial Interest:  15,000 HKD
Repayment:         -1,000 HKD
Repayment:         -1,000 HKD
Payment Failed:     1,000 HKD
Late repayment fee:   100 HKD
    </pre>
  </div>

  <div class="slide">
    <h2>My Model</h2>
    <pre>
class LoanLedger
  property :type, String
  property :principal_amount, BigInt
  property :interest_amount,  BigInt
  property :fee_amount,       BigInt
  property :rounding,         Decimal
  property :description, String
end
     </pre>
  </div>
  
  <div class="slide">
    <h2>Classify these types</h2>
    <p>Amount Disbursed: initial</p>
    <p>Initial Interest: initial</p>
    <p>Repayment: payment</p>
    <p>Payment Failed: payment</p>
    ...
  </div>
  
  <div class="slide">
    <h2>Sum over these Classifications</h2>
    <pre>
class Loan
  def total_principal
    ledgers.initial.sum(:principal)
  end
  def total_interest
    ledgers.initial.sum(:interest)
  end
  
  def repaid_principal
    ledgers.payment.sum(:principal)
  end
  
  def outstanding_principal
    ledgers.sum(:principal)
  end
end
    </pre>
  </div>
  
  <div class="slide">
    <h1>The Accountants were right!</h1>
  </div>
  
  
  <div class="slide">
    <h1>7. Rounding</h1>
    <h2>Get Rich Quick</h2>
  </div>
  
  <div class="slide">
    <h1>Two types of rounding</h1>
  </div>
  
  <div class="slide">
    <h2>#1 - Non-balanceable Rounding</h2>
    <p>"Your commission is X% Rounded to the nearest Dollar"</p>
    <p>Non-persistent!</p>
    <p>Easy</p>
  </div>
  
  <div class="slide">
    <h2>#2 - Balanceable Rounding</h2>
    <p>"Interest will be added daily at X%"</p>
    <p>Persistent!</p>
    <p>Difficult</p>
  </div>
  
  <div class="slide">
    <h2>A loan of 1¢, at 0.1% per day</h2>
    <ul>
      <li class="incremental">Day 1. 0.01 USD</li>
      <li class="incremental">Day 2. 0.02 USD</li>
      <li class="incremental">Day 3. 0.03 USD</li>
    </ul>
    <h2 class="incremental">100% a day</h2>
  </div>
    
  <div class="slide">
    <h2>A loan of 1¢, at 0.1% per day- storing rounding</h2>
    <ul>
      <li class="incremental">Day 1. 0.01 USD (0¢ rounding)</li>
      <li class="incremental">Day 2. 0.02 USD (-0.999¢ rounding)</li>
      <li class="incremental">Day 3. 0.02 USD (-0.998¢ rounding)</li>
    </ul>
    <h2 class="incremental">0.1% a day</h2>
  </div>

  8. System Security

    Let someone else do the work!

    User permissioning
    * Devise
    * CanCan
    * strong passwords

    Firewall
    * different IP address for SSH access
    * whitelist IP addresses for SSH access
    * non-standard port for SSH access

    Chef
    * creates user accounts
    * configures SSH security (no root login, no passwords)
    * configures Postgres security (access limited to local ips, specific users, and specific databases)
    * only run the services we need

  9. Data Security

    Don't leave your laptop on the train!

    If you don't have the data on your machine
    you can't lose it.

    Rules
    * no client data outside the data centre
    * local development uses obfuscated data
  
	
</body>
</html>
